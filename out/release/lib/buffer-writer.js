// Generated by CoffeeScript 1.7.1
var BufferWriter, fs;

fs = require('fs');

BufferWriter = (function() {
  function BufferWriter(file, size) {
    this.file = file;
    this.size = size != null ? size : 1048576;
    this.fd = fs.openSync(this.file, 'w', '0664');
    this.offset = 0;
    this.buffer = new Buffer(this.size);
    this.length = 0;
  }

  BufferWriter.prototype.write = function(data) {
    var size;
    if (!(data instanceof Buffer)) {
      data = new Buffer(data);
    }
    size = this.size;
    if (data.length + this.length <= size) {
      this.append(data);
    } else if (data.length < size) {
      this.flush().append(data);
    } else {
      this.flush()._write(data, data.length);
    }
  };

  BufferWriter.prototype.append = function(data) {
    this.length += data.copy(this.buffer, this.length);
    return this;
  };

  BufferWriter.prototype.flush = function() {
    if (this.length > 0) {
      this._write(this.buffer, this.length);
      this.length = 0;
    }
    return this;
  };

  BufferWriter.prototype._write = function(buf, length) {
    return this.offset += fs.writeSync(this.fd, buf, 0, length, this.offset);
  };

  BufferWriter.prototype.close = function() {
    this.flush();
    return fs.closeSync(this.fd);
  };

  return BufferWriter;

})();

module.exports = function(file, size) {
  return new BufferWriter(file, size);
};

module.exports.BufferWriter = BufferWriter;
